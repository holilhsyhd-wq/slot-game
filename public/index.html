<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>QiuQiu Mabar</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- AUTH BOX -->
<div id="authBox" class="center-box">
  <h1>QiuQiu Mabar</h1>

  <div class="auth-section">
    <h3>Daftar Akun</h3>
    <input id="regEmail" placeholder="Email (Gmail)">
    <input id="regUsername" placeholder="Username">
    <input id="regPhone" placeholder="Nomor HP">
    <input id="regPassword" type="password" placeholder="Password">
    <button id="registerBtn">Daftar</button>
  </div>

  <div class="auth-section">
    <h3>Login</h3>
    <input id="logUsername" placeholder="Username">
    <input id="logPassword" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>
</div>

<!-- GAME BOX -->
<div id="gameBox" class="hidden">
  <h2>QiuQiu Mabar</h2>
  <p id="userInfo"></p>
  <p id="pointsText"></p>

  <div class="section">
    <h3>Room</h3>
    <input id="roomIdInput" placeholder="ID room (misal: abc123)">
    <button id="createRoomBtn">Buat Room</button>
    <button id="joinRoomBtn">Join Room</button>
    <p>Room aktif: <span id="currentRoomText">-</span></p>
  </div>

  <div class="section layout">
    <div class="col">
      <h3>Pemain</h3>
      <ul id="playerList"></ul>
    </div>

    <div class="col">
      <h3>Taruhan & Kartu</h3>
      <input id="betInput" type="number" min="10" placeholder="Jumlah taruhan">
      <button id="betBtn">Pasang Taruhan</button>
      <p id="betStatus">Belum bertaruh</p>
      <button id="startRoundBtn">Mulai Ronde</button>

      <h4>Kartumu</h4>
      <div id="cardsArea"></div>
    </div>

    <div class="col">
      <h3>Chat</h3>
      <div id="chatBox"></div>
      <input id="chatInput" placeholder="Ketik pesan...">
      <button id="sendChatBtn">Kirim</button>
    </div>
  </div>
</div>

<!-- SCRIPT UTAMA -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getDatabase, ref, set, get, update, push, onValue
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  // ==========================
  // KONFIGURASI FIREBASE
  // ==========================
  const firebaseConfig = {
    apiKey: "AIzaSyD0-qqQiuQiuGameKeyXz123",
    authDomain: "qiuqiu-mabar.firebaseapp.com",
    databaseURL: "https://qiuqiu-mabar-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "qiuqiu-mabar",
    storageBucket: "qiuqiu-mabar.appspot.com",
    messagingSenderId: "880122990111",
    appId: "1:880122990111:web:qiuqiu-mabar-2025"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ==========================
  // ELEMENT DOM
  // ==========================
  const authBox = document.getElementById("authBox");
  const gameBox = document.getElementById("gameBox");

  const regEmail = document.getElementById("regEmail");
  const regUsername = document.getElementById("regUsername");
  const regPhone = document.getElementById("regPhone");
  const regPassword = document.getElementById("regPassword");
  const registerBtn = document.getElementById("registerBtn");

  const logUsername = document.getElementById("logUsername");
  const logPassword = document.getElementById("logPassword");
  const loginBtn = document.getElementById("loginBtn");

  const userInfo = document.getElementById("userInfo");
  const pointsText = document.getElementById("pointsText");

  const roomIdInput = document.getElementById("roomIdInput");
  const createRoomBtn = document.getElementById("createRoomBtn");
  const joinRoomBtn = document.getElementById("joinRoomBtn");
  const currentRoomText = document.getElementById("currentRoomText");

  const playerList = document.getElementById("playerList");
  const betInput = document.getElementById("betInput");
  const betBtn = document.getElementById("betBtn");
  const betStatus = document.getElementById("betStatus");
  const startRoundBtn = document.getElementById("startRoundBtn");
  const cardsArea = document.getElementById("cardsArea");

  const chatBox = document.getElementById("chatBox");
  const chatInput = document.getElementById("chatInput");
  const sendChatBtn = document.getElementById("sendChatBtn");

  // user yang sedang login
  let currentUser = null; // {username, email, phone, points}
  let currentRoom = null;

  // ==========================
  // REGISTER
  // ==========================
  registerBtn.onclick = async () => {
    const email = regEmail.value.trim();
    const username = regUsername.value.trim();
    const phone = regPhone.value.trim();
    const password = regPassword.value.trim();

    if (!email || !username || !phone || !password) {
      alert("Semua data harus diisi.");
      return;
    }
    if (!email.includes("@")) {
      alert("Email tidak valid.");
      return;
    }
    if (username.includes(" ")) {
      alert("Username tidak boleh pakai spasi.");
      return;
    }

    const userRef = ref(db, "users/" + username);
    const snap = await get(userRef);
    if (snap.exists()) {
      alert("Username sudah dipakai.");
      return;
    }

    const newUser = {
      username,
      email,
      phone,
      password, // NOTE: plain text, cuma buat game. Jangan dipakai buat hal serius.
      points: 1000
    };

    await set(userRef, newUser);

    currentUser = newUser;
    masukGame();
  };

  // ==========================
  // LOGIN
  // ==========================
  loginBtn.onclick = async () => {
    const username = logUsername.value.trim();
    const password = logPassword.value.trim();

    if (!username || !password) {
      alert("Isi username dan password.");
      return;
    }

    const userRef = ref(db, "users/" + username);
    const snap = await get(userRef);
    if (!snap.exists()) {
      alert("Akun tidak ditemukan.");
      return;
    }

    const data = snap.val();
    if (data.password !== password) {
      alert("Password salah.");
      return;
    }

    currentUser = data;
    masukGame();
  };

  // ==========================
  // MASUK KE GAME
  // ==========================
  async function masukGame() {
    authBox.classList.add("hidden");
    gameBox.classList.remove("hidden");

    const snap = await get(ref(db, "users/" + currentUser.username));
    const data = snap.val();
    currentUser.points = data.points;

    userInfo.innerText = "Login sebagai: " + currentUser.username;
    pointsText.innerText = "Poin: " + currentUser.points;
  }

  async function refreshPoints() {
    const snap = await get(ref(db, "users/" + currentUser.username));
    currentUser.points = snap.val().points;
    pointsText.innerText = "Poin: " + currentUser.points;
  }

  // ==========================
  // ROOM
  // ==========================
  createRoomBtn.onclick = async () => {
    const roomId = Math.random().toString(36).substring(2, 8);
    currentRoom = roomId;
    currentRoomText.innerText = roomId;

    await set(ref(db, "rooms/" + roomId), {
      players: {
        [currentUser.username]: {
          name: currentUser.username,
          bet: 0,
          cards: []
        }
      },
      chat: []
    });

    listenRoom();
  };

  joinRoomBtn.onclick = async () => {
    const roomId = roomIdInput.value.trim();
    if (!roomId) {
      alert("Isi ID room dulu.");
      return;
    }

    const roomRef = ref(db, "rooms/" + roomId);
    const snap = await get(roomRef);
    if (!snap.exists()) {
      alert("Room tidak ditemukan.");
      return;
    }

    currentRoom = roomId;
    currentRoomText.innerText = roomId;

    await update(ref(db, "rooms/" + roomId + "/players"), {
      [currentUser.username]: {
        name: currentUser.username,
        bet: 0,
        cards: []
      }
    });

    listenRoom();
  };

  // ==========================
  // LISTEN ROOM
  // ==========================
  function listenRoom() {
    if (!currentRoom) return;

    // pemain
    onValue(ref(db, "rooms/" + currentRoom + "/players"), snap => {
      const players = snap.val() || {};
      playerList.innerHTML = "";

      Object.values(players).forEach(p => {
        const li = document.createElement("li");
        li.innerText = p.name + " | Taruhan: " + (p.bet || 0);
        playerList.appendChild(li);
      });

      if (players[currentUser.username]?.cards) {
        tampilkanKartu(players[currentUser.username].cards);
      }
    });

    // chat
    onValue(ref(db, "rooms/" + currentRoom + "/chat"), snap => {
      const logs = snap.val() || [];
      chatBox.innerHTML = "";
      logs.forEach(m => {
        const div = document.createElement("div");
        div.innerText = m.sender + ": " + m.text;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  // ==========================
  // CHAT
  // ==========================
  sendChatBtn.onclick = async () => {
    const text = chatInput.value.trim();
    if (!text || !currentRoom) return;

    await push(ref(db, "rooms/" + currentRoom + "/chat"), {
      sender: currentUser.username,
      text
    });

    chatInput.value = "";
  };

  // ==========================
  // TARUHAN & RONDE
  // ==========================
  betBtn.onclick = async () => {
    if (!currentRoom) return alert("Belum ada room.");

    const bet = parseInt(betInput.value);
    if (!bet || bet < 10) {
      alert("Minimal taruhan 10 poin.");
      return;
    }

    const snap = await get(ref(db, "users/" + currentUser.username));
    const pts = snap.val().points;
    if (bet > pts) {
      alert("Poin tidak cukup.");
      return;
    }

    await update(ref(db, "rooms/" + currentRoom + "/players/" + currentUser.username), {
      bet
    });

    betStatus.innerText = "Taruhan kamu: " + bet;
  };

  startRoundBtn.onclick = async () => {
    if (!currentRoom) return;

    const snap = await get(ref(db, "rooms/" + currentRoom + "/players"));
    const players = snap.val();
    const uids = Object.keys(players);

    for (let u of uids) {
      if (!players[u].bet || players[u].bet <= 0) {
        alert("Semua pemain harus bertaruh.");
        return;
      }
    }

    const updates = {};
    uids.forEach(u => {
      updates[u] = {
        ...players[u],
        cards: [
          randomCard(),
          randomCard(),
          randomCard(),
          randomCard()
        ]
      };
    });

    await update(ref(db, "rooms/" + currentRoom + "/players"), updates);

    setTimeout(() => hitungPemenang(), 1500);
  };

  // ==========================
  // LOGIKA QIUQIU
  // ==========================
  function nilaiPair(c1, c2) {
    const [a1, a2] = c1.split("|").map(Number);
    const [b1, b2] = c2.split("|").map(Number);
    return (a1 + a2 + b1 + b2) % 10;
  }

  function nilaiTerbaik(cards) {
    return Math.max(
      nilaiPair(cards[0], cards[1]),
      nilaiPair(cards[0], cards[2]),
      nilaiPair(cards[0], cards[3]),
      nilaiPair(cards[1], cards[2]),
      nilaiPair(cards[1], cards[3]),
      nilaiPair(cards[2], cards[3])
    );
  }

  async function hitungPemenang() {
    const snap = await get(ref(db, "rooms/" + currentRoom + "/players"));
    const players = snap.val();
    const uids = Object.keys(players);

    let best = -1;
    const winners = [];

    const nilai = {};
    uids.forEach(u => {
      nilai[u] = nilaiTerbaik(players[u].cards);
      if (nilai[u] > best) best = nilai[u];
    });

    uids.forEach(u => {
      if (nilai[u] === best) winners.push(u);
    });

    let pot = 0;
    uids.forEach(u => pot += players[u].bet || 0);

    const share = Math.floor(pot / winners.length);

    // update poin semua pemain
    for (let u of uids) {
      const userRef = ref(db, "users/" + u);
      const s = await get(userRef);
      let pts = s.val().points;

      if (winners.includes(u)) pts += share;
      else pts -= players[u].bet || 0;

      await update(userRef, { points: pts });
    }

    // reset taruhan
    for (let u of uids) {
      await update(ref(db, "rooms/" + currentRoom + "/players/" + u), {
        bet: 0
      });
    }

    betStatus.innerText = "Belum bertaruh";
    await refreshPoints();
    alert("Pemenang nilai " + best + " (" + winners.length + " orang)");
  }

  function randomCard() {
    const a = Math.floor(Math.random() * 7);
    const b = Math.floor(Math.random() * 7);
    return `${a}|${b}`;
  }

  function tampilkanKartu(cards) {
    cardsArea.innerHTML = "";
    cards.forEach(c => {
      const div = document.createElement("div");
      div.className = "card-tile";
      div.innerText = c;
      cardsArea.appendChild(div);
    });
  }
</script>

</body>
</html>
