<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>QiuQiu Mabar Simple</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="loginBox" class="center-box">
  <h1>QiuQiu Mabar</h1>
  <button id="loginBtn">Login dengan Google</button>
</div>

<div id="gameBox" class="hidden">
  <h2>QiuQiu Mabar</h2>
  <p id="userInfo"></p>
  <p id="pointsText"></p>

  <div class="section">
    <h3>Room</h3>
    <input id="roomIdInput" placeholder="ID room (misal: abc123)">
    <button id="createRoomBtn">Buat Room</button>
    <button id="joinRoomBtn">Join Room</button>
    <p>Room saat ini: <span id="currentRoomText">-</span></p>
  </div>

  <div class="section layout">
    <div class="col">
      <h3>Pemain</h3>
      <ul id="playerList"></ul>
    </div>

    <div class="col">
      <h3>Taruhan & Kartu</h3>
      <input id="betInput" type="number" min="10" placeholder="Jumlah taruhan">
      <button id="betBtn">Pasang Taruhan</button>
      <p id="betStatus">Belum bertaruh</p>
      <button id="startRoundBtn">Mulai Ronde</button>
      <h4>Kartumu</h4>
      <div id="cardsArea"></div>
    </div>

    <div class="col">
      <h3>Chat</h3>
      <div id="chatBox"></div>
      <input id="chatInput" placeholder="Ketik pesan...">
      <button id="sendChatBtn">Kirim</button>
    </div>
  </div>
</div>

<!-- SCRIPT UTAMA (SEMUA LOGIC DI SINI) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { 
    getDatabase, ref, set, update, onValue, get, push 
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  // TODO: GANTI CONFIG INI DENGAN PROJECT FIREBASE KAMU SENDIRI
  const firebaseConfig = {
    apiKey: "AIzaSyD0-qqQiuQiuGameKeyXz123",
    authDomain: "qiuqiu-mabar.firebaseapp.com",
    databaseURL: "https://qiuqiu-mabar-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "qiuqiu-mabar",
    storageBucket: "qiuqiu-mabar.appspot.com",
    messagingSenderId: "880122990111",
    appId: "1:880122990111:web:qiuqiu-mabar-2025"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // DOM
  const loginBox = document.getElementById("loginBox");
  const gameBox = document.getElementById("gameBox");
  const loginBtn = document.getElementById("loginBtn");
  const userInfo = document.getElementById("userInfo");
  const pointsText = document.getElementById("pointsText");

  const roomIdInput = document.getElementById("roomIdInput");
  const createRoomBtn = document.getElementById("createRoomBtn");
  const joinRoomBtn = document.getElementById("joinRoomBtn");
  const currentRoomText = document.getElementById("currentRoomText");

  const playerList = document.getElementById("playerList");
  const betInput = document.getElementById("betInput");
  const betBtn = document.getElementById("betBtn");
  const betStatus = document.getElementById("betStatus");
  const startRoundBtn = document.getElementById("startRoundBtn");
  const cardsArea = document.getElementById("cardsArea");

  const chatBox = document.getElementById("chatBox");
  const chatInput = document.getElementById("chatInput");
  const sendChatBtn = document.getElementById("sendChatBtn");

  let currentUser = null;
  let currentRoom = null;

  // LOGIN GOOGLE
  loginBtn.onclick = async () => {
    try {
      const res = await signInWithPopup(auth, provider);
      currentUser = res.user;
      await afterLogin(currentUser);
    } catch (e) {
      alert("Login gagal: " + e.message);
    }
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await afterLogin(user);
    }
  });

  async function afterLogin(user) {
    // cek user di database
    const userRef = ref(db, "users/" + user.uid);
    const snap = await get(userRef);
    if (!snap.exists()) {
      await set(userRef, {
        uid: user.uid,
        name: user.displayName,
        points: 1000
      });
    }
    const data = (await get(userRef)).val();

    loginBox.classList.add("hidden");
    gameBox.classList.remove("hidden");

    userInfo.innerText = "Login sebagai: " + data.name;
    pointsText.innerText = "Poin: " + data.points;
  }

  // CEK POIN TERKINI USER
  async function getMyPoints() {
    const snap = await get(ref(db, "users/" + currentUser.uid));
    return snap.val().points;
  }

  async function refreshMyPoints() {
    const pts = await getMyPoints();
    pointsText.innerText = "Poin: " + pts;
  }

  // BUAT ROOM
  createRoomBtn.onclick = async () => {
    const roomId = Math.random().toString(36).substring(2, 8);
    currentRoom = roomId;
    currentRoomText.innerText = roomId;

    await set(ref(db, "rooms/" + roomId), {
      players: {
        [currentUser.uid]: {
          name: currentUser.displayName,
          bet: 0,
          cards: []
        }
      },
      chat: []
    });

    listenRoom();
  };

  // JOIN ROOM
  joinRoomBtn.onclick = async () => {
    const roomId = roomIdInput.value.trim();
    if (!roomId) return alert("Masukkan ID room dulu");

    const roomRef = ref(db, "rooms/" + roomId);
    const snap = await get(roomRef);
    if (!snap.exists()) return alert("Room tidak ditemukan");

    currentRoom = roomId;
    currentRoomText.innerText = roomId;

    await update(ref(db, "rooms/" + roomId + "/players"), {
      [currentUser.uid]: {
        name: currentUser.displayName,
        bet: 0,
        cards: []
      }
    });

    listenRoom();
  };

  // LISTEN ROOM (PEMAIN + CHAT)
  function listenRoom() {
    if (!currentRoom) return;

    // pemain
    onValue(ref(db, "rooms/" + currentRoom + "/players"), snap => {
      const players = snap.val() || {};
      playerList.innerHTML = "";
      Object.values(players).forEach(p => {
        const li = document.createElement("li");
        li.innerText = p.name + " | Taruhan: " + (p.bet || 0);
        playerList.appendChild(li);
      });

      if (players[currentUser.uid]?.cards) {
        displayMyCards(players[currentUser.uid].cards);
      }
    });

    // chat
    onValue(ref(db, "rooms/" + currentRoom + "/chat"), snap => {
      const logs = snap.val() || [];
      chatBox.innerHTML = "";
      logs.forEach(m => {
        const div = document.createElement("div");
        div.innerText = m.sender + ": " + m.text;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  // KIRIM CHAT
  sendChatBtn.onclick = async () => {
    const text = chatInput.value.trim();
    if (!text || !currentRoom) return;
    await push(ref(db, "rooms/" + currentRoom + "/chat"), {
      sender: currentUser.displayName,
      text
    });
    chatInput.value = "";
  };

  // PASANG TARUHAN
  betBtn.onclick = async () => {
    if (!currentRoom) return alert("Belum di room");

    const bet = parseInt(betInput.value);
    if (!bet || bet < 10) return alert("Minimal 10 poin");

    const myPoints = await getMyPoints();
    if (bet > myPoints) return alert("Poin tidak cukup");

    await update(ref(db, "rooms/" + currentRoom + "/players/" + currentUser.uid), {
      bet: bet
    });

    betStatus.innerText = "Taruhan kamu: " + bet;
  };

  // MULAI RONDE
  startRoundBtn.onclick = async () => {
    if (!currentRoom) return;

    const playersSnap = await get(ref(db, "rooms/" + currentRoom + "/players"));
    const players = playersSnap.val();
    const uids = Object.keys(players);

    // cek semua sudah bet
    for (let uid of uids) {
      if (!players[uid].bet || players[uid].bet <= 0) {
        alert("Semua pemain harus bertaruh dulu");
        return;
      }
    }

    // bagi kartu
    const updates = {};
    uids.forEach(uid => {
      updates[uid] = {
        ...players[uid],
        cards: [
          randomCard(),
          randomCard(),
          randomCard(),
          randomCard()
        ]
      };
    });

    await update(ref(db, "rooms/" + currentRoom + "/players"), updates);

    // hitung pemenang
    setTimeout(() => calculateWinner(), 1500);
  };

  // QIUQIU: HITUNG NILAI
  function pairValue(c1, c2) {
    const [a1, a2] = c1.split("|").map(Number);
    const [b1, b2] = c2.split("|").map(Number);
    return (a1 + a2 + b1 + b2) % 10;
  }

  function bestValue(cards) {
    const vals = [
      pairValue(cards[0], cards[1]),
      pairValue(cards[0], cards[2]),
      pairValue(cards[0], cards[3]),
      pairValue(cards[1], cards[2]),
      pairValue(cards[1], cards[3]),
      pairValue(cards[2], cards[3])
    ];
    return Math.max(...vals);
  }

  async function calculateWinner() {
    const playersSnap = await get(ref(db, "rooms/" + currentRoom + "/players"));
    const players = playersSnap.val();
    const uids = Object.keys(players);

    let best = -1;
    const winnerUids = [];
    const values = {};

    uids.forEach(uid => {
      const v = bestValue(players[uid].cards);
      values[uid] = v;
      if (v > best) best = v;
    });

    uids.forEach(uid => {
      if (values[uid] === best) winnerUids.push(uid);
    });

    // total pot
    let pot = 0;
    uids.forEach(uid => pot += players[uid].bet || 0);

    const perWinner = Math.floor(pot / winnerUids.length);

    // update poin semua pemain
    for (let uid of uids) {
      const userRef = ref(db, "users/" + uid);
      const snap = await get(userRef);
      let cur = snap.val().points;

      if (winnerUids.includes(uid)) {
        cur += perWinner;
      } else {
        cur -= players[uid].bet || 0;
      }
      await update(userRef, { points: cur });
    }

    // reset bet
    for (let uid of uids) {
      await update(ref(db, "rooms/" + currentRoom + "/players/" + uid), {
        bet: 0
      });
    }

    await refreshMyPoints();
    alert("Pemenang nilai tertinggi: " + best + " (jumlah pemenang: " + winnerUids.length + ")");
    betStatus.innerText = "Belum bertaruh";
  }

  // KARTU RANDOM
  function randomCard() {
    const a = Math.floor(Math.random() * 7);
    const b = Math.floor(Math.random() * 7);
    return `${a}|${b}`;
  }

  function displayMyCards(cards) {
    cardsArea.innerHTML = "";
    cards.forEach(c => {
      const div = document.createElement("div");
      div.className = "card-tile";
      div.innerText = c;
      cardsArea.appendChild(div);
    });
  }
</script>
</body>
</html>
