<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>QiuQiu Mabar</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="loginBox" class="center-box">
  <h1>QiuQiu Mabar</h1>
  <button id="loginBtn">Login dengan Google</button>
</div>

<div id="gameBox" class="hidden">
  <h2>QiuQiu Mabar</h2>
  <p id="userInfo"></p>
  <p id="pointsText"></p>

  <div class="section">
    <h3>Room</h3>
    <input id="roomIdInput" placeholder="ID room">
    <button id="createRoomBtn">Buat Room</button>
    <button id="joinRoomBtn">Join Room</button>
    <p>Room aktif: <span id="currentRoomText">-</span></p>
  </div>

  <div class="section layout">
    <div class="col">
      <h3>Pemain</h3>
      <ul id="playerList"></ul>
    </div>

    <div class="col">
      <h3>Taruhan</h3>
      <input id="betInput" type="number" min="10" placeholder="Jumlah taruhan">
      <button id="betBtn">Pasang Taruhan</button>
      <p id="betStatus">Belum bertaruh</p>
      <button id="startRoundBtn">Mulai Ronde</button>
      <h4>Kartumu</h4>
      <div id="cardsArea"></div>
    </div>

    <div class="col">
      <h3>Chat</h3>
      <div id="chatBox"></div>
      <input id="chatInput" placeholder="Ketik pesan...">
      <button id="sendChatBtn">Kirim</button>
    </div>
  </div>
</div>

<!-- SCRIPT UTAMA -->
<script type="module">
  // ========================================
  // FIREBASE
  // ========================================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { 
    getDatabase, ref, set, update, get, push, onValue 
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  import {
    getAuth, GoogleAuthProvider,
    signInWithRedirect, getRedirectResult,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD0-qqQiuQiuGameKeyXz123",
    authDomain: "qiuqiu-mabar.firebaseapp.com",
    databaseURL: "https://qiuqiu-mabar-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "qiuqiu-mabar",
    storageBucket: "qiuqiu-mabar.appspot.com",
    messagingSenderId: "880122990111",
    appId: "1:880122990111:web:qiuqiu-mabar-2025"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // ========================================
  // ELEMENT DOM
  // ========================================
  const loginBox = document.getElementById("loginBox");
  const gameBox = document.getElementById("gameBox");
  const loginBtn = document.getElementById("loginBtn");
  const userInfo = document.getElementById("userInfo");
  const pointsText = document.getElementById("pointsText");
  const roomIdInput = document.getElementById("roomIdInput");
  const createRoomBtn = document.getElementById("createRoomBtn");
  const joinRoomBtn = document.getElementById("joinRoomBtn");
  const currentRoomText = document.getElementById("currentRoomText");
  const playerList = document.getElementById("playerList");
  const betInput = document.getElementById("betInput");
  const betBtn = document.getElementById("betBtn");
  const betStatus = document.getElementById("betStatus");
  const startRoundBtn = document.getElementById("startRoundBtn");
  const cardsArea = document.getElementById("cardsArea");
  const chatBox = document.getElementById("chatBox");
  const chatInput = document.getElementById("chatInput");
  const sendChatBtn = document.getElementById("sendChatBtn");

  let currentUser = null;
  let currentRoom = null;

  // ========================================
  // LOGIN GOOGLE (REDIRECT â€“ 100% ANTI MENTAL)
  // ========================================
  loginBtn.onclick = () => {
    signInWithRedirect(auth, provider);
  };

  getRedirectResult(auth).then(async (result) => {
    if (result) {
      currentUser = result.user;
      await afterLogin(currentUser);
    }
  });

  onAuthStateChanged(auth, async (user) => {
    if (user && !currentUser) {
      currentUser = user;
      await afterLogin(user);
    }
  });

  async function afterLogin(user) {
    const userRef = ref(db, "users/" + user.uid);
    const snap = await get(userRef);

    if (!snap.exists()) {
      await set(userRef, {
        uid: user.uid,
        name: user.displayName,
        points: 1000
      });
    }

    loginBox.classList.add("hidden");
    gameBox.classList.remove("hidden");

    const data = (await get(userRef)).val();
    userInfo.innerText = "Login sebagai: " + data.name;
    pointsText.innerText = "Poin: " + data.points;
  }

  async function getMyPoints() {
    const snap = await get(ref(db, "users/" + currentUser.uid));
    return snap.val().points;
  }

  async function refreshPoints() {
    pointsText.innerText = "Poin: " + await getMyPoints();
  }

  // ========================================
  // BUAT ROOM
  // ========================================
  createRoomBtn.onclick = async () => {
    const id = Math.random().toString(36).substring(2, 8);
    currentRoom = id;
    currentRoomText.innerText = id;

    await set(ref(db, "rooms/" + id), {
      players: {
        [currentUser.uid]: {
          name: currentUser.displayName,
          bet: 0,
          cards: []
        }
      },
      chat: []
    });

    listenRoom();
  };

  // ========================================
  // JOIN ROOM
  // ========================================
  joinRoomBtn.onclick = async () => {
    const id = roomIdInput.value.trim();
    if (!id) return alert("Isi ID room dulu.");

    const snap = await get(ref(db, "rooms/" + id));
    if (!snap.exists()) return alert("Room tidak ditemukan.");

    currentRoom = id;
    currentRoomText.innerText = id;

    await update(ref(db, "rooms/" + id + "/players"), {
      [currentUser.uid]: {
        name: currentUser.displayName,
        bet: 0,
        cards: []
      }
    });

    listenRoom();
  };

  // ========================================
  // LISTEN ROOM (PEMAIN + CHAT)
  // ========================================
  function listenRoom() {
    if (!currentRoom) return;

    onValue(ref(db, "rooms/" + currentRoom + "/players"), snap => {
      const players = snap.val() || {};
      playerList.innerHTML = "";

      Object.values(players).forEach(p => {
        const li = document.createElement("li");
        li.innerText = p.name + " | Taruhan: " + (p.bet || 0);
        playerList.appendChild(li);
      });

      if (players[currentUser.uid]?.cards) {
        displayMyCards(players[currentUser.uid].cards);
      }
    });

    onValue(ref(db, "rooms/" + currentRoom + "/chat"), snap => {
      const logs = snap.val() || [];
      chatBox.innerHTML = "";
      logs.forEach(m => {
        const div = document.createElement("div");
        div.innerText = m.sender + ": " + m.text;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  sendChatBtn.onclick = async () => {
    const text = chatInput.value.trim();
    if (!text || !currentRoom) return;

    await push(ref(db, "rooms/" + currentRoom + "/chat"), {
      sender: currentUser.displayName,
      text
    });
    chatInput.value = "";
  };

  // ========================================
  // TARUHAN & RONDE
  // ========================================
  betBtn.onclick = async () => {
    const bet = parseInt(betInput.value);
    if (!bet || bet < 10) return alert("Minimal 10 poin.");

    const pts = await getMyPoints();
    if (bet > pts) return alert("Poin tidak cukup.");

    await update(ref(db, `rooms/${currentRoom}/players/${currentUser.uid}`), {
      bet: bet
    });

    betStatus.innerText = "Taruhan kamu: " + bet;
  };

  startRoundBtn.onclick = async () => {
    const snap = await get(ref(db, `rooms/${currentRoom}/players`));
    const players = snap.val();
    const uids = Object.keys(players);

    for (let uid of uids)
      if (!players[uid].bet) return alert("Semua pemain harus bertaruh.");

    const upd = {};
    uids.forEach(uid => {
      upd[uid] = {
        ...players[uid],
        cards: [
          randomCard(),
          randomCard(),
          randomCard(),
          randomCard()
        ]
      };
    });

    await update(ref(db, `rooms/${currentRoom}/players`), upd);

    setTimeout(() => hitungPemenang(), 1500);
  };

  // ========================================
  // HITUNG MENANG QIUQIU
  // ========================================

  function nilaiPair(c1, c2) {
    const [a1, a2] = c1.split("|").map(Number);
    const [b1, b2] = c2.split("|").map(Number);
    return (a1 + a2 + b1 + b2) % 10;
  }

  function nilaiTerbaik(cards) {
    return Math.max(
      nilaiPair(cards[0], cards[1]),
      nilaiPair(cards[0], cards[2]),
      nilaiPair(cards[0], cards[3]),
      nilaiPair(cards[1], cards[2]),
      nilaiPair(cards[1], cards[3]),
      nilaiPair(cards[2], cards[3])
    );
  }

  async function hitungPemenang() {
    const snap = await get(ref(db, `rooms/${currentRoom}/players`));
    const players = snap.val();
    const uids = Object.keys(players);

    let terbaik = -1;
    const winners = [];

    const nilai = {};
    uids.forEach(uid => {
      nilai[uid] = nilaiTerbaik(players[uid].cards);
      if (nilai[uid] > terbaik) terbaik = nilai[uid];
    });

    uids.forEach(uid => {
      if (nilai[uid] === terbaik) winners.push(uid);
    });

    let pot = 0;
    uids.forEach(uid => pot += players[uid].bet);

    const hadiah = Math.floor(pot / winners.length);

    for (let uid of uids) {
      const userRef = ref(db, "users/" + uid);
      const snap = await get(userRef);
      let pts = snap.val().points;

      if (winners.includes(uid)) pts += hadiah;
      else pts -= players[uid].bet;

      await update(userRef, { points: pts });
    }

    for (let uid of uids)
      await update(ref(db, `rooms/${currentRoom}/players/${uid}`), { bet: 0 });

    betStatus.innerText = "Belum bertaruh";
    await refreshPoints();
    alert("Pemenang (nilai tertinggi " + terbaik + "): " + winners.length + " pemain");
  }

  function randomCard() {
    return `${Math.floor(Math.random() * 7)}|${Math.floor(Math.random() * 7)}`;
  }

  function displayMyCards(cards) {
    cardsArea.innerHTML = "";
    cards.forEach(c => {
      const div = document.createElement("div");
      div.className = "card-tile";
      div.innerText = c;
      cardsArea.appendChild(div);
    });
  }
</script>

</body>
</html>
